/*! Simplebird 04-04-2013 */
function tmpl(t,e){return Templates[t]=Templates[t]||Hogan.compile($("#"+t).html()),Templates[t].render(e)}function init(){Grailbird={cur_page:0,payload_details:payload_details,user_details:user_details,tweet_index:tweet_index,data:{},date:function(){var t=this.tweet_index[this.cur_page],e=t.month||0,a=t.year;return CalendarMonths[e-1]+" "+a},tweet_count:function(){var t=this.tweet_index[this.cur_page];return t.tweet_count},tweet_history:function(){for(var t=[],e=0,a=Grailbird.tweet_index[0].year,r=1;0!=r;){var n=$.grep(Grailbird.tweet_index,function(t){return e=Math.max(e,t.tweet_count),t.calendar_month=CalendarMonths[t.month-1],t.url=t.var_name.split("tweets_").join(""),t.year==a});if(n.reverse(),r=n.length,0==r)break;for(var i=n[0].month;n.length>0&&12>n.length;)1==i?n.push({year:a,tweet_count:0,month:n.length+1,calendar_month:CalendarMonths[n.length]}):(n.unshift({year:a,tweet_count:0,month:i,calendar_month:CalendarMonths[i]}),i+=1);t.push({year:a,months:n,max_tweet_count:e}),a--}return t},hasPrev:function(){return!!(this.cur_page<this.tweet_index.length-1)},hasNext:function(){return!(0==this.cur_page)}},$("header").html(tmpl("tmpl_header",Grailbird.user_details)),$(".newtweet").on("click",openTweetActionInWindow),loadTweetsAtCurrentUrl(),setTimeout(function(){$("#tweet_history").html(tmpl("tmpl_history",Grailbird)),drawTweetHistory(),refreshActiveHistory()},10),History.Adapter.bind(window,"statechange",loadTweetsAtCurrentUrl)}function loadTweetsAtCurrentUrl(){var t=History.getState(),e=t.hash.split("?date=")[1];e?loadHistoryFromVarName("tweets_"+e):refresh()}function prev(){$("#prev").off("click"),loadPage(Math.min(Grailbird.tweet_index.length-1,Grailbird.cur_page+1))}function next(){$("#next").off("click"),loadPage(Math.max(0,Grailbird.cur_page-1))}function loadPage(t){$("#tweet_list").addClass("hidden"),scrollTo("#main",150),setTimeout(function(){Grailbird.cur_page=t,refresh()},150)}function openTweetActionInWindow(t){t.preventDefault(),window.open(t.target.getAttribute("href"),"","width=520,height=360,menubar=no,toolbar=no")}function toggleTweetHistory(t,e){t.preventDefault();var a=$("#main"),e=void 0===e?!a.hasClass("menu_open"):e;e?scrollTo("#main",150,function(){a.addClass("menu_open");var t=Math.min(parseInt($("#tweet_history").css("height")),parseInt($("#tweet_history").css("max-height")));$(".menu_open section").css({"-webkit-transform":"translateY("+t+"px)","-moz-transform":"translateY("+t+"px)","-ms-transform":"translateY("+t+"px)",transform:"translateY("+t+"px)"})}):($(".menu_open section").css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"",transform:""}),a.removeClass("menu_open"))}function refresh(){$("nav").html(tmpl("tmpl_nav",Grailbird)),$("#prev").on("click",prev),$("#next").on("click",next),$("#toggle_history").on("click",toggleTweetHistory),refreshActiveHistory(),loadTweets(tweet_index[Grailbird.cur_page],function(){})}function drawTweetHistory(){var t=parseInt($("#tweet_history ol.tweet_months").data("max-tweet-count"));$("#tweet_history a .count_bar").each(function(e,a){var r=parseInt($(a).data("tweet-count"))/t;$(a).height(100-100*r+"%")}),$("#tweet_history .bar a").on("click",function(t){t.preventDefault();var e=$(t.target).attr("href")||$(t.target).parents("a").attr("href");History.pushState(null,null,e)})}function refreshActiveHistory(){$("#tweet_history .active").removeClass("active").parents(".tweet_year").removeClass("active"),$("#tweet_history .bar[data-var-name="+Grailbird.tweet_index[Grailbird.cur_page].var_name+"]").addClass("active").parents(".tweet_year").addClass("active")}function loadHistoryFromVarName(t){if(t){var e;$.each(Grailbird.tweet_index,function(a,r){e||r.var_name!=t||(e=a)}),loadPage(e)}}function loadTweets(t){var e=Grailbird.data[t.var_name];e?drawTweets(e):$.getScript(t.file_name,function(){drawTweets(Grailbird.data[t.var_name])})}function drawTweets(t){var e,a="";dataset=t,$.each(t,function(t,r){e=r.retweeted_status||r,r.formatted_content=e.formatted_content=r.formatted_content||getFormattedTweetContent(e),r.formatted_date=e.formatted_date=r.formatted_date||getFormattedDate(e.created_at),r.retweeted_status&&(e.retweeter=r.user.screen_name),a+=tmpl("tmpl_tweet",e)}),setTimeout(function(){$("#tweet_list").html(a).removeClass("hidden"),$(".tweet_actions a").on("click",openTweetActionInWindow)},1)}function scrollTo(t,e,a){$("html, body").animate({scrollTop:$(t).offset().top},e,"swing",a)}function getFormattedTweetContent(t){var e=t.text,a=t.entities;return $.each(a.hashtags,function(t){e=e.replace(RegExp("#"+t.text,"g"),'<a href="http://twitter.com/search/'+escape(t.text)+'">#'+t.text+"</a>")}),$.each(a.urls,function(t,a){e=e.replace(RegExp(a.url,"g"),'<a title="'+a.expanded_url+'" href="'+a.expanded_url+'">'+a.display_url+"</a>")}),$.each(a.user_mentions,function(t,a){e=e.replace(RegExp("@"+a.screen_name,"g"),'<a class="atname" href="http://twitter.com/'+a.screen_name+'">'+a.screen_name+"</a>")}),e}function getFormattedDate(t){return new Date(t).toDateString()}var Grailbird={},Templates={},CalendarMonths=["January","February","March","April","May","June","July","August","September","October","November","December"];$.when($.getScript("data/js/payload_details.js"),$.getScript("data/js/user_details.js"),$.getScript("data/js/tweet_index.js")).then(init);