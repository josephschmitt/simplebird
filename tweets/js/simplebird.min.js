/*! Simplebird 24-05-2013 */
function tmpl(e,t){return Templates[e]=Templates[e]||Hogan.compile($("#"+e).html()),Templates[e].render(t)}function init(){Grailbird={cur_page:0,payload_details:payload_details,user_details:user_details,tweet_index:tweet_index,data:{},date:function(){var e=this.tweet_index[this.cur_page],t=e.month||0,r=e.year;return CalendarMonths[t-1]+" "+r},tweet_count:function(){var e=this.tweet_index[this.cur_page];return e.tweet_count},tweet_history:function(){for(var e=[],t=0,r=Grailbird.tweet_index[0].year,a=1;0!=a;){var n=$.grep(Grailbird.tweet_index,function(e){t=Math.max(t,e.tweet_count),e.calendar_month=CalendarMonths[e.month-1];var a=e.var_name.split("tweets_").join("");return e.url=Config.useCleanUrl?Config.baseUrl+"/"+a:"?data="+a,e.year==r});if(n.reverse(),a=n.length,0==a)break;for(var i=n[0].month;n.length>0&&12>n.length;)1==i?n.push({year:r,tweet_count:0,month:n.length+1,calendar_month:CalendarMonths[n.length]}):(n.unshift({year:r,tweet_count:0,month:i,calendar_month:CalendarMonths[i]}),i+=1);e.push({year:r,months:n,max_tweet_count:t}),r--}return e},hasPrev:function(){return!!(this.cur_page<this.tweet_index.length-1)},hasNext:function(){return!(0==this.cur_page)}},GrailbirdSearch={hasPrev:!1,hasNext:!1,date:"",tweet_count:""};var e=CalendarMonths[Grailbird.tweet_index[Grailbird.tweet_index.length-1].month-1]+" "+Grailbird.tweet_index[Grailbird.tweet_index.length-1].year,t=CalendarMonths[Grailbird.tweet_index[0].month-1]+" "+Grailbird.tweet_index[0].year;document.title="Tweets for "+Grailbird.user_details.full_name+" (@"+Grailbird.user_details.screen_name+"), "+e+"—"+t,$("header").html(tmpl("tmpl_header",Grailbird.user_details)),$(".newtweet_btn").on("click",openTweetActionInWindow),$(".search_btn").on("click",toggleSearch),$(".search_header").on("submit",onSearchSubmit),$("input[type=search]").on("submit",onSearchSubmit);var r=getTweetVarFromUrl();r?loadHistoryFromVarName(r):refresh(),setTimeout(function(){$("#tweet_history").html(tmpl("tmpl_history",Grailbird)),drawTweetHistory(),refreshActiveHistory()},10),History.Adapter.bind(window,"statechange",onUrlChange)}function onUrlChange(){hasUrlChanged=!0,loadHistoryFromVarName(getTweetVarFromUrl())}function prev(){$("#prev").off("click"),loadPage(Math.min(Grailbird.tweet_index.length-1,Grailbird.cur_page+1))}function next(){$("#next").off("click"),loadPage(Math.max(0,Grailbird.cur_page-1))}function loadPage(e){$("#tweet_list").addClass("hidden"),scrollTo("#main",150),setTimeout(function(){Grailbird.cur_page=e,refresh()},150)}function loadHistoryFromVarName(e){if(e){var t=0;$.each(Grailbird.tweet_index,function(r,a){t||a.var_name!=e||(t=r)}),loadPage(t)}}function openTweetActionInWindow(e){e.preventDefault();var t=520,r=360,a="menubar=no,toolbar=no,width="+t+",height="+r+",left="+(window.screenX+$("body").width()/2-t/2)+", top="+(window.screenY+80);window.open(e.target.getAttribute("href"),"",a)}function toggleSearch(){$(document.body).hasClass("search")?hideSearch():showSearch()}function showSearch(){$("input[type=search]").focus(),setTimeout(function(){$(document.body).addClass("search")},50)}function hideSearch(){$(document.body).removeClass("search").removeClass("searching").removeClass("more").removeClass("searched"),setTimeout(function(){refresh()},250)}function onSearchSubmit(e){e.preventDefault();var t=$("input[type=search]").val();search(t)}function toggleTweetHistory(e,t){e.preventDefault();var r=$("#main"),t=void 0===t?!r.hasClass("menu_open"):t;t?(scrollTo("#main",150),setTimeout(function(){r.addClass("menu_open");var e=Math.min(parseInt($("#tweet_history").css("height")),parseInt($("#tweet_history").css("max-height")));$("#main").css("height",$("#main").height()+e+"px"),$(".menu_open section").css({"-webkit-transform":"translateY("+e+"px)","-moz-transform":"translateY("+e+"px)","-ms-transform":"translateY("+e+"px)",transform:"translateY("+e+"px)"})},150)):($("#main").css("height",""),$(".menu_open section").css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"",transform:""}),r.removeClass("menu_open"))}function refresh(){$("nav").html(tmpl("tmpl_nav",Grailbird)),$("#prev").on("click",prev),$("#next").on("click",next),$("#toggle_history").show().on("click",toggleTweetHistory),refreshActiveHistory(),loadTweets(tweet_index[Grailbird.cur_page]),updateUrl()}function search(e){function t(){return $.SearchIndex({action:"init",options:[Config.baseUrl]})}function r(){var e=$.grep(Grailbird.tweet_index,function(e){return!!Grailbird.data[e.var_name]}).map(function(e){return e.var_name});return $.SearchIndex({action:"indexAll",options:[Grailbird.data,e]})}function a(){return $.SearchIndex({action:"search",options:[e]})}function n(){var e=[],t=[];return $.each(Grailbird.tweet_index,function(r,a){Grailbird.data[a.var_name]||(e.push($.getScript(baseFolder+a.file_name)),t.push(a.var_name))}),$.when.apply(null,e)}function i(e){return $.map(e,function(e){var t=e.ref.split("/"),r=t[0],a=t[1];return $.grep(Grailbird.data[r],function(e){return e=e.retweeted_status||e,e.id_str==a})})}$(document.body).addClass("searching"),showSearchResults(e),$.when(t(),r(),a()).done(function(t,r,a){$(document.body).addClass("more"),showSearchResults(e,i(a))}).then(function(){$.when(n()).done(function(){}).then(function(){$.when(r(),a()).done(function(t,r){$(document.body).removeClass("searching").removeClass("more").addClass("searched"),showSearchResults(e,i(r))})})})}function showSearchResults(e,t){$("input[type=search]").blur(),GrailbirdSearch.date="“"+e+"”",GrailbirdSearch.tweet_count=t?t.length:null,$("nav").html(tmpl("tmpl_nav",GrailbirdSearch)),setTimeout(function(){drawTweets(t||[])},10)}function updateUrl(){if(!hasUrlChanged){var e=0!==Grailbird.cur_page?tweet_index[Grailbird.cur_page].var_name:"",t=getUrlFromTweetVar(e);Config.useCleanUrl&&History.getState().hash.indexOf("date=")>-1?History.replaceState(null,null,t):e&&History.pushState(null,null,t)}hasUrlChanged=!1}function drawTweetHistory(){var e=parseInt($("#tweet_history ol.tweet_months").data("max-tweet-count"));$("#tweet_history a .count_bar").each(function(t,r){var a=parseInt($(r).data("tweet-count"))/e;$(r).height(100-100*a+"%")}),$("#tweet_history .bar a").on("click",function(e){e.preventDefault();var t=$(e.target).attr("href")||$(e.target).parents("a").attr("href");loadHistoryFromVarName(getTweetVarFromUrl(t))})}function refreshActiveHistory(){$("#tweet_history .active").removeClass("active").parents(".tweet_year").removeClass("active"),$("#tweet_history .bar[data-var-name="+Grailbird.tweet_index[Grailbird.cur_page].var_name+"]").addClass("active").parents(".tweet_year").addClass("active")}function loadTweets(e){var t=Grailbird.data[e.var_name];t?drawTweets(t,e.var_name):$.getScript(baseFolder+e.file_name,function(){drawTweets(Grailbird.data[e.var_name],e.var_name)})}function drawTweets(e){var t,r="";if($.each(e,function(e,a){t=a.retweeted_status||a,a.formatted_content=t.formatted_content=a.formatted_content||getFormattedTweetContent(t),a.formatted_date=t.formatted_date=a.formatted_date||getFormattedDate(t.created_at),a.retweeted_status&&(t.retweeter=a.user.screen_name),a.indexed=!0,r+=tmpl("tmpl_tweet",t)}),$(document.body).hasClass("searching")){var a={more:$(document.body).hasClass("more")};console.log("data",a),r+=tmpl("tmpl_searching",a)}setTimeout(function(){$("#main").css("height",""),$("#tweet_list").html(r).removeClass("hidden"),$(".tweet_actions a").on("click",openTweetActionInWindow)},1)}function scrollTo(e,t,r){$("html, body").animate({scrollTop:$(e).offset().top},t,"swing",r)}function getTweetVarFromUrl(e){e=e||History.getState().hash;var t;return e.split("?date=").length>1?t=e.split("?date=")[1].split("&")[0]:Config.useCleanUrl&&e.split(Config.baseUrl).length>1&&(t=e.split(Config.baseUrl)[1].split("/").join("")),t?"tweets_"+t:null}function getUrlFromTweetVar(e){return Config.useCleanUrl?Config.baseUrl+"/"+e.split("tweets_").join(""):"?date="+e.split("tweets_").join("")}function getFormattedTweetContent(e){var t=e.text,r=e.entities;return $.each(r.hashtags,function(e){t=t.replace(RegExp("#"+e.text,"g"),'<a href="http://twitter.com/search/'+escape(e.text)+'">#'+e.text+"</a>")}),$.each(r.urls,function(e,r){t=t.replace(RegExp(r.url,"g"),'<a title="'+r.expanded_url+'" href="'+r.expanded_url+'">'+r.display_url+"</a>")}),$.each(r.user_mentions,function(e,r){t=t.replace(RegExp("@"+r.screen_name,"g"),'<a class="atname" href="http://twitter.com/'+r.screen_name+'">'+r.screen_name+"</a>")}),t}function getFormattedDate(e){return new Date(e).toDateString()}var Grailbird={},Templates={},CalendarMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],hasUrlChanged=!1,baseFolder=Config.useCleanUrl?Config.baseUrl+"/":"",IndexWorker=new Worker(Config.baseUrl+"/js/simplebird.index.js");IndexWorker.addEventListener("message",function(e){"log"==e.data.msg&&console.log("Worker Log:",e.data.options)}),$.SearchIndex=function(e){var t=$.Deferred(function(t){IndexWorker.addEventListener("message",function(r){r.data.action==e.action&&("complete"==r.data.msg?t.resolve(r.data.data):"error"==r.data.msg&&t.reject(r))}),IndexWorker.addEventListener("error",function(e){t.reject(e)}),IndexWorker.postMessage({action:e.action,options:e.options})});return t.promise()},$.when($.getScript(baseFolder+"data/js/payload_details.js"),$.getScript(baseFolder+"data/js/user_details.js"),$.getScript(baseFolder+"data/js/tweet_index.js")).then(init);