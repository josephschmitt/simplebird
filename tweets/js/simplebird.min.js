/*! Simplebird 05-04-2013 */
function tmpl(e,t){return Templates[e]=Templates[e]||Hogan.compile($("#"+e).html()),Templates[e].render(t)}function init(){Grailbird={cur_page:0,payload_details:payload_details,user_details:user_details,tweet_index:tweet_index,data:{},date:function(){var e=this.tweet_index[this.cur_page],t=e.month||0,a=e.year;return CalendarMonths[t-1]+" "+a},tweet_count:function(){var e=this.tweet_index[this.cur_page];return e.tweet_count},tweet_history:function(){for(var e=[],t=0,a=Grailbird.tweet_index[0].year,r=1;0!=r;){var n=$.grep(Grailbird.tweet_index,function(e){return t=Math.max(t,e.tweet_count),e.calendar_month=CalendarMonths[e.month-1],e.url=e.var_name.split("tweets_").join(""),e.year==a});if(n.reverse(),r=n.length,0==r)break;for(var i=n[0].month;n.length>0&&12>n.length;)1==i?n.push({year:a,tweet_count:0,month:n.length+1,calendar_month:CalendarMonths[n.length]}):(n.unshift({year:a,tweet_count:0,month:i,calendar_month:CalendarMonths[i]}),i+=1);e.push({year:a,months:n,max_tweet_count:t}),a--}return e},hasPrev:function(){return!!(this.cur_page<this.tweet_index.length-1)},hasNext:function(){return!(0==this.cur_page)}},$("header").html(tmpl("tmpl_header",Grailbird.user_details)),$(".newtweet").on("click",openTweetActionInWindow);var e=getTweetVarFromUrl();e?loadHistoryFromVarName(e):refresh(),setTimeout(function(){$("#tweet_history").html(tmpl("tmpl_history",Grailbird)),drawTweetHistory(),refreshActiveHistory()},10),History.Adapter.bind(window,"statechange",onUrlChange)}function onUrlChange(){hasUrlChanged=!0,loadHistoryFromVarName(getTweetVarFromUrl())}function prev(){$("#prev").off("click"),loadPage(Math.min(Grailbird.tweet_index.length-1,Grailbird.cur_page+1))}function next(){$("#next").off("click"),loadPage(Math.max(0,Grailbird.cur_page-1))}function loadPage(e){$("#tweet_list").addClass("hidden"),scrollTo("#main",150),setTimeout(function(){Grailbird.cur_page=e,refresh()},150)}function loadHistoryFromVarName(e){if(e){var t=0;$.each(Grailbird.tweet_index,function(a,r){t||r.var_name!=e||(t=a)}),loadPage(t)}}function openTweetActionInWindow(e){e.preventDefault(),window.open(e.target.getAttribute("href"),"","width=520,height=360,menubar=no,toolbar=no")}function toggleTweetHistory(e,t){e.preventDefault();var a=$("#main"),t=void 0===t?!a.hasClass("menu_open"):t;t?scrollTo("#main",150,function(){a.addClass("menu_open");var e=Math.min(parseInt($("#tweet_history").css("height")),parseInt($("#tweet_history").css("max-height")));$(".menu_open section").css({"-webkit-transform":"translateY("+e+"px)","-moz-transform":"translateY("+e+"px)","-ms-transform":"translateY("+e+"px)",transform:"translateY("+e+"px)"})}):($(".menu_open section").css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"",transform:""}),a.removeClass("menu_open"))}function refresh(){if($("nav").html(tmpl("tmpl_nav",Grailbird)),$("#prev").on("click",prev),$("#next").on("click",next),$("#toggle_history").on("click",toggleTweetHistory),refreshActiveHistory(),loadTweets(tweet_index[Grailbird.cur_page]),!hasUrlChanged){var e=getUrlFromTweetVar(tweet_index[Grailbird.cur_page].var_name);Config.useCleanUrl&&History.getState().hash.indexOf("date=")>-1?History.replaceState(null,null,e):History.pushState(null,null,e)}hasUrlChanged=!1}function drawTweetHistory(){var e=parseInt($("#tweet_history ol.tweet_months").data("max-tweet-count"));$("#tweet_history a .count_bar").each(function(t,a){var r=parseInt($(a).data("tweet-count"))/e;$(a).height(100-100*r+"%")}),$("#tweet_history .bar a").on("click",function(e){e.preventDefault();var t=$(e.target).attr("href")||$(e.target).parents("a").attr("href");loadHistoryFromVarName(getTweetVarFromUrl(t))})}function refreshActiveHistory(){$("#tweet_history .active").removeClass("active").parents(".tweet_year").removeClass("active"),$("#tweet_history .bar[data-var-name="+Grailbird.tweet_index[Grailbird.cur_page].var_name+"]").addClass("active").parents(".tweet_year").addClass("active")}function loadTweets(e){var t=Grailbird.data[e.var_name];t?drawTweets(t):$.getScript(e.file_name,function(){drawTweets(Grailbird.data[e.var_name])})}function drawTweets(e){var t,a="";dataset=e,$.each(e,function(e,r){t=r.retweeted_status||r,r.formatted_content=t.formatted_content=r.formatted_content||getFormattedTweetContent(t),r.formatted_date=t.formatted_date=r.formatted_date||getFormattedDate(t.created_at),r.retweeted_status&&(t.retweeter=r.user.screen_name),a+=tmpl("tmpl_tweet",t)}),setTimeout(function(){$("#tweet_list").html(a).removeClass("hidden"),$(".tweet_actions a").on("click",openTweetActionInWindow)},1)}function scrollTo(e,t,a){$("html, body").animate({scrollTop:$(e).offset().top},t,"swing",a)}function getTweetVarFromUrl(e){e=e||History.getState().hash;var t;return e.split("?date=").length>1?t=e.split("?date=")[1].split("&")[0]:Config.useCleanUrl&&e.split(Config.baseUrl).length>1&&(t=e.split(Config.baseUrl)[1].split("/").join("")),t?"tweets_"+t:null}function getUrlFromTweetVar(e){return Config.useCleanUrl?Config.baseUrl+"/"+e.split("tweets_").join(""):"?date="+e.split("tweets_").join("")}function getFormattedTweetContent(e){var t=e.text,a=e.entities;return $.each(a.hashtags,function(e){t=t.replace(RegExp("#"+e.text,"g"),'<a href="http://twitter.com/search/'+escape(e.text)+'">#'+e.text+"</a>")}),$.each(a.urls,function(e,a){t=t.replace(RegExp(a.url,"g"),'<a title="'+a.expanded_url+'" href="'+a.expanded_url+'">'+a.display_url+"</a>")}),$.each(a.user_mentions,function(e,a){t=t.replace(RegExp("@"+a.screen_name,"g"),'<a class="atname" href="http://twitter.com/'+a.screen_name+'">'+a.screen_name+"</a>")}),t}function getFormattedDate(e){return new Date(e).toDateString()}var Grailbird={},Templates={},CalendarMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],hasUrlChanged=!1;$.when($.getScript("data/js/payload_details.js"),$.getScript("data/js/user_details.js"),$.getScript("data/js/tweet_index.js")).then(init);